<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Chat - AI Assistant</title>
    <style>
        /* ==================================================================== */
        /* CSS Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø´Ø§Ù…Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„) */
        /* ==================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(145deg,#f0f2f5,#d9e2ec);
            color: #333;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(90deg,#4f86f7,#4fc3f7);
            color: #fff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #fff; }
        .chat-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message { margin-bottom: 12px; display: flex; flex-direction: column; }
        .message.user .message-content { align-self: flex-end; background: #4fc3f7; color: #fff; }
        .message.ai .message-content { align-self: flex-start; background: #e0e0e0; color: #333; }
        .message-content {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
            transition: transform 0.2s ease;
        }
        .typing-indicator { display: flex; align-items: center; margin-top: 5px; padding: 10px; }
        .typing-dots span {
            display: inline-block;
            width: 8px; height: 8px;
            background: #888;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .input-area {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #fff;
            border-top: 1px solid #ddd;
        }
        .input-wrapper { flex: 1; margin: 0 10px; }
        .input-wrapper input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid #ccc;
            outline: none;
            font-size: 16px;
            transition: border 0.3s;
        }
        .icon-btn {
            background: #4fc3f7;
            border: none;
            color: #fff;
            width: 45px;
            height: 45px;
            margin: 0 2px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .icon-btn.recording { background: #f44336; animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 rgba(244,67,54,0.5); }
            50% { box-shadow: 0 0 20px rgba(244,67,54,0.7); }
            100% { box-shadow: 0 0 0 rgba(244,67,54,0.5); }
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
        .privacy-modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .privacy-content {
            background-color: #fefefe;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: right;
        }
        .privacy-content h2 {
            color: #f44336;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            direction: rtl;
        }
        .privacy-content .warning-point {
            background: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #856404;
        }
        .privacy-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .privacy-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        #rejectPrivacy { background-color: #f44336; color: white; }
        #acceptPrivacy { background-color: #4CAF50; color: white; }
        .code-block { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; margin: 10px 0; position: relative; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 14px; }
        .code-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #4b5263; }
        .code-lang { color: #61afef; font-weight: bold; }
        .copy-btn { background: #61afef; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
    </style>
</head>
<body>

<div class="overlay" id="overlay"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h3>
        <button class="close-btn" id="closeSidebar">âœ•</button>
    </div>
    <button class="new-chat-btn" id="newChatBtn">+ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <div class="chat-history" id="chatHistory"></div>
</div>

<div class="container">
    <div class="header">
        <button class="menu-btn" id="menuBtn">â˜°</button>
        <div class="header-title">G Chat - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
        <div style="width: 40px;"></div>
    </div>
    <div class="chat-area" id="chatArea"></div>
    <div class="input-area">
        <button class="icon-btn" id="cameraBtn" title="ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ“·</button>
        <button class="icon-btn" id="micBtn" title="Ù…Ø§ÙŠÙƒ">ğŸ¤</button>
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
        </div>
        <button class="icon-btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">â¤</button>
    </div>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
<canvas id="canvas" style="display:none"></canvas>

<div class="privacy-modal" id="privacyModal">
    <div class="privacy-content">
        <h2>âš ï¸ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h2>
        
        <div class="warning-point">
            Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…ÙŠØ²Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³ØªÙ†Ø§.
        </div>

        <p>
            Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù€ G Chat Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ **Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§** Ùˆ **Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†** Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹Ù„Ù… Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:
        </p>

        <ul>
            <li>**Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:** Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ØªØ±Ø³Ù„ **Ù…Ø¨Ø§Ø´Ø±Ø©** Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Gemini) Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§. **Ù„Ù† ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù…Ù†Ø§.**</li>
            <li>**Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:** Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙ„Ø§Ù…Ùƒ Ø¥Ù„Ù‰ Ù†Øµ (Speech-to-Text) ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. **Ù„Ù† ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£Ùˆ ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ.**</li>
            <li>**Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù†Ù…ÙˆØ°Ø¬ Gemini ØªØ®Ø¶Ø¹ Ù„Ø³ÙŠØ§Ø³Ø§Øª OpenRouter (Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©).</li>
        </ul>

        <p style="font-weight: bold; color: #f44336;">
            Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø£ÙˆØ§ÙÙ‚"ØŒ ÙØ£Ù†Øª ØªØ³Ù…Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø·Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ù…Ù† Ù…ØªØµÙØ­Ùƒ.
        </p>

        <div class="privacy-actions">
            <button id="rejectPrivacy">Ù„Ø§ Ø£ÙˆØ§ÙÙ‚ (Ø¥Ù„ØºØ§Ø¡)</button>
            <button id="acceptPrivacy">Ø£ÙˆØ§ÙÙ‚ ÙˆØ§Ø³ØªÙ…Ø±</button>
        </div>
    </div>
</div>

<script>
    // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø®Ø§Øµ Ù…Ù† OpenRouter
    const OPENROUTER_KEY = "sk-or-v1-YOUR-SECRET-KEY"; 
    
    const API_MODEL = "google/gemini-2.5-flash"; 

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const chatArea = document.getElementById('chatArea');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const cameraInput = document.getElementById('cameraInput');
    const privacyModal = document.getElementById('privacyModal');
    const acceptPrivacy = document.getElementById('acceptPrivacy');
    const rejectPrivacy = document.getElementById('rejectPrivacy');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menuBtn');
    const closeSidebar = document.getElementById('closeSidebar');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatHistory = document.getElementById('chatHistory');

    let recognition = null;
    let isRecording = false;
    let conversationHistory = [];
    let isTyping = false;
    let currentChatId = Date.now().toString();
    let chats = {};
    let privacyAccepted = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙˆØµÙŠØ©
    let pendingAction = null; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù‚ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙŠÙƒ)
    
    // ====================================================================
    // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)
    // ====================================================================

    function loadFromStorage() {
        // (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ)
        const savedChats = localStorage.getItem('gchats');
        if (savedChats) {
            chats = JSON.parse(savedChats);
            const chatIds = Object.keys(chats);
            if (chatIds.length > 0) {
                currentChatId = chatIds[chatIds.length - 1];
                loadChat(currentChatId);
            } else {
                createNewChat();
            }
        } else {
            createNewChat();
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        if (localStorage.getItem('privacyAccepted') === 'true') {
            privacyAccepted = true;
        }
        
        // (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«)
    }

    function saveToStorage() {
        localStorage.setItem('gchats', JSON.stringify(chats));
    }
    
    // (Ø¯ÙˆØ§Ù„ addMessage, createNewChat, loadChat, updateChatHistory, formatCodeResponse, Ø¥Ù„Ø®.)
    // ... (Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¹Ø¯ ÙˆØ¶Ø¹ Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù‡Ù†Ø§) ...
    
    function addMessage(text, sender) {
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…Ø¨Ø³Ø·Ø© Ù‡Ù†Ø§)
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = text;
        messageDiv.appendChild(contentDiv);
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;

        // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø¨Ø³Ø· Ù‡Ù†Ø§)
        if (!chats[currentChatId]) return;
        if (!chats[currentChatId].messages) {
            chats[currentChatId].messages = [];
        }
        chats[currentChatId].messages.push({
            text: text,
            sender: sender
        });
        saveToStorage();
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©
    function createNewChat() {
        currentChatId = Date.now().toString();
        chats[currentChatId] = {
            id: currentChatId,
            title: 'Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            messages: [],
            history: [],
            timestamp: Date.now()
        };
        conversationHistory = [];
        chatArea.innerHTML = '';
        // initTypingIndicator(); // ÙŠØ¬Ø¨ ØªØ¶Ù…ÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
        addMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ G ChatØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini.', 'ai');
        saveToStorage();
        // updateChatHistory(); // ÙŠØ¬Ø¨ ØªØ¶Ù…ÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function loadChat(chatId) {
        currentChatId = chatId;
        const chat = chats[chatId];
        conversationHistory = chat.history || [];
        chatArea.innerHTML = '';
        chat.messages.forEach(msg => {
            addMessage(msg.text, msg.sender);
        });
        // updateChatHistory(); // ÙŠØ¬Ø¨ ØªØ¶Ù…ÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
    }

    // ====================================================================
    // ÙˆØ¸Ø§Ø¦Ù API ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
    // ====================================================================

    async function sendToAI(message, type = 'text', imageBase64 = null) {
        if (isTyping) return;
        
        isTyping = true;
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡)
        
        try {
            const messages = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù„Ù„Ø³ÙŠØ§Ù‚)
            conversationHistory.forEach(msg => {
                const content = msg.text.replace(' [ØµÙˆØ±Ø©]', '').trim();
                messages.push({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: content
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù†Øµ Ø£Ùˆ Ù†Øµ Ù…Ø¹ ØµÙˆØ±Ø©)
            if (type === 'image' && imageBase64) {
                messages.push({
                    role: "user",
                    content: [
                        { type: "image_url", image_url: { url: imageBase64 } },
                        { type: "text", text: message }
                    ]
                });
            } else {
                messages.push({ role: "user", content: message });
            }

            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${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}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": API_MODEL,
                    "messages": messages,
                    "temperature": 0.7 
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }));
                addMessage(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ${errorData.message || ''}`, 'ai');
                return;
            }

            const data = await response.json();
            
            if (data.choices && data.choices.length > 0) {
                const aiResponse = data.choices[0].message.content;
                addMessage(aiResponse, 'ai');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ
                conversationHistory.push({ 
                    sender: 'user', 
                    text: type === 'image' ? (message || 'ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©') + ' [ØµÙˆØ±Ø©]' : message 
                });
                conversationHistory.push({ sender: 'ai', text: aiResponse });
                
                if(chats[currentChatId]) {
                    chats[currentChatId].history = conversationHistory;
                    saveToStorage();
                }
            } else {
                addMessage("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙØ§Ø±ØºØ©.", 'ai');
            }

        } catch (error) {
            addMessage("Ø®Ø·Ø£ Ø¹Ø§Ù…: ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ API ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", 'ai');
        } finally {
            isTyping = false;
            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡)
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }
    }

    // ====================================================================
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø®ØµÙˆØµÙŠØ©)
    // ====================================================================

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…)
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ar-SA';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            micBtn.classList.add('recording');
            isRecording = true;
            userInput.placeholder = "ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...";
        };

        recognition.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            userInput.value = transcript;
        };

        recognition.onend = () => {
            micBtn.classList.remove('recording');
            isRecording = false;
            userInput.placeholder = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...";
        };
    } else {
        micBtn.disabled = true;
        micBtn.title = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª";
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©)
    cameraInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (event) => {
                const imageBase64 = event.target.result;
                const userMessage = userInput.value.trim() || "ØµÙ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„.";
                
                addMessage(userMessage + ' [ØµÙˆØ±Ø©]', 'user');
                userInput.value = '';

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„ÙˆØµÙ Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                await sendToAI(userMessage, 'image', imageBase64);
            };
            reader.readAsDataURL(file);
        }
    });

    // ====================================================================
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    // ====================================================================

    function showPrivacyModal(action) {
        pendingAction = action;
        privacyModal.style.display = 'flex';
    }

    function hidePrivacyModal() {
        privacyModal.style.display = 'none';
        pendingAction = null;
    }

    acceptPrivacy.addEventListener('click', () => {
        privacyAccepted = true;
        hidePrivacyModal();
        localStorage.setItem('privacyAccepted', 'true');
        
        if (pendingAction === 'camera') {
            cameraInput.click();
        } else if (pendingAction === 'mic') {
            if (recognition) recognition.start();
        }
    });

    rejectPrivacy.addEventListener('click', () => {
        hidePrivacyModal();
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø¯ÙˆÙ† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©.');
    });

    // ====================================================================
    // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    // ====================================================================

    cameraBtn.addEventListener('click', () => {
        if (privacyAccepted) {
            cameraInput.click(); // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        } else {
            showPrivacyModal('camera');
        }
    });

    micBtn.addEventListener('click', () => {
        if (!recognition) return;
        
        if (isRecording) {
            recognition.stop();
        } else {
            if (privacyAccepted) {
                recognition.start(); // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ù…Ø§ÙŠÙƒ
            } else {
                showPrivacyModal('mic');
            }
        }
    });

    // Ø­Ø¯Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ù†Øµ
    const handleSend = async () => {
        const message = userInput.value.trim();
        if (message === "" || isTyping) return;

        addMessage(message, 'user');
        userInput.value = '';

        await sendToAI(message, 'text');
    };

    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSend();
        }
    });

    // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø³ÙŠØ¯Ø¨Ø§Ø±)
    // (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† ÙƒÙˆØ¯ ØªÙ‡ÙŠØ¦Ø© Sidebar Ù‡Ù†Ø§)
    
    // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    window.addEventListener('load', loadFromStorage);
</script>
</body>
</html>